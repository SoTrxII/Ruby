<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: classes/JukeboxYoutubeItem.js</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="styles/prettify-tomorrow.css" rel="stylesheet" type="text/css">
    <link href="styles/jsdoc-default.css" rel="stylesheet" type="text/css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: classes/JukeboxYoutubeItem.js</h1>


    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const JukeboxItem = require('./JukeboxItem');
const ytdl = require('ytdl-core');
const utils = require('util');
const ytAPI = new(require('youtube-node'))();

//SearchPm --> Search with promise
const searchPm = utils.promisify(ytAPI.search)
const debug = require('debug')('jukeboxYoutubeItem')

ytAPI.setKey(global.Config.API.Google.youtubeParser);

/**
 * @class
 * @extends JukeboxItem
 */
class JukeboxYoutubeItem extends JukeboxItem {

    constructor(track, voiceConnection, asker) {
        super(track, voiceConnection, asker);
        //Deferred promise
        let resolve, reject;
        /**
         * @public
         * @member {Promise&lt;Object>} infos Infos about the video
         * @desc Uses a deferred promise that resolve when the informations are fetched 
         */
        this.infos = new Promise(function () {
            resolve = arguments[0];
            reject = arguments[1];
        });
        this._retrieveInfo(resolve, reject).catch(console.err);
    }

    /**
     * @override 
     * @public
     * @summary Play the source
     */
    play(options) {
        super.play();
        this._dispatcher = this._voiceConnection.playStream(
            ytdl(this.track, {
                filter: 'audioonly',
                highWaterMark: 1024 * 1024 * 10 //Give the song a 10Mb buffer size (default : 16kb)
            }),
            options
        )
        this._dispatcher.on('end', (evt) => {
            /**
             * Emitted when an item stops playing
             * @event JukeboxItem#end
             */
            this.emit('end');
        })
    }

    /**
     * @async
     * @summary Retrieve the video infos from Youtube and reduce it to what we need.
     * @param {function} resolve Resolve deferred @see{@link infos} promise
     * @param {function} reject Resolve deferred @see{@link infos} promise
     */
    async _retrieveInfo(resolve, reject) {
        const data = await ytdl.getInfo(this.track).catch(reject);

        resolve({
            title: data.title,
            author: data.author.name,
            description: data.description,
            image: `https://img.youtube.com/vi/${data.video_id}/0.jpg`,
            url: this.track
        });

    }

    /**
     * @async
     * @static
     * @override
     * @public
     * @summary Search for item to playback
     * @param query Whatto search for
     * @param {Discord/VoiceConnection} voiceConnection voicechannel to play into
     * @param {Discord/Member} asker 
     * @param {Integer} [MAX_RESULTS=3]
     * @return {JukeboxItem[]}
     */
    static async search(query, voiceConnection, asker, MAX_RESULTS = 3) {
        let res = await searchPm(query, MAX_RESULTS).catch( (err) => {
            console.error(err);
            return null;
        });

        if(!res || !res.items || !res.items.length){
            return null;
        }

        
        res = res.items;
        //Only keep videos (exclude playlist)
        res = res.filter(item => {
            return item.id.kind === "youtube#video"
        });

        //Return urls
        res = res.map( item => {
            return new JukeboxYoutubeItem(
                `https://www.youtube.com/watch?v=${item.id.videoId}`,
                voiceConnection,
                asker
            );
        })

        return res

    }

    /**
     * @private
     * @override
     * @returns Info about the playback
     */
    async _getInfo() {
        return await this.infos;
    }

}

module.exports = JukeboxYoutubeItem;</code></pre>
        </article>
    </section>


</div>

<nav>
    <h2><a href="index.html">Home</a></h2>
    <h3>Modules</h3>
    <ul>
        <li><a href="module-parseTextCommand.html">parseTextCommand</a></li>
    </ul>
    <h3>Classes</h3>
    <ul>
        <li><a href="Jukebox.html">Jukebox</a></li>
        <li><a href="JukeboxFanburstItem.html">JukeboxFanburstItem</a></li>
        <li><a href="JukeboxItem.html">JukeboxItem</a></li>
        <li><a href="JukeboxLocalItem.html">JukeboxLocalItem</a></li>
        <li><a href="JukeboxOpeningmoeItem.html">JukeboxOpeningmoeItem</a></li>
        <li><a href="JukeboxYoutubeItem.html">JukeboxYoutubeItem</a></li>
    </ul>
    <h3>Events</h3>
    <ul>
        <li><a href="Jukebox.html#event:QueueEmpty">QueueEmpty</a></li>
        <li><a href="JukeboxFanburstItem.html#event:end">end</a></li>
        <li><a href="JukeboxItem.html#event:end">end</a></li>
        <li><a href="JukeboxLocalItem.html#event:end">end</a></li>
        <li><a href="JukeboxOpeningmoeItem.html#event:end">end</a></li>
        <li><a href="JukeboxYoutubeItem.html#event:end">end</a></li>
    </ul>
    <h3>Global</h3>
    <ul>
        <li><a href="global.html#_supportedSources">_supportedSources</a></li>
        <li><a href="global.html#addToQueue">addToQueue</a></li>
        <li><a href="global.html#asker">asker</a></li>
        <li><a href="global.html#blindTest">blindTest</a></li>
        <li><a href="global.html#chooseOneItem">chooseOneItem</a></li>
        <li><a href="global.html#displayMessage">displayMessage</a></li>
        <li><a href="global.html#exitHandler">exitHandler</a></li>
        <li><a href="global.html">expiration</a></li>
        <li><a href="global.html#getMember">getMember</a></li>
        <li><a href="global.html#hasBegun">hasBegun</a></li>
        <li><a href="global.html#infos">infos</a></li>
        <li><a href="global.html#isBlindTest">isBlindTest</a></li>
        <li><a href="global.html#isPaused">isPaused</a></li>
        <li><a href="global.html#isPlaying">isPlaying</a></li>
        <li><a href="global.html#list">list</a></li>
        <li><a href="global.html">openingListUpdateDate</a></li>
        <li><a href="global.html#pause">pause</a></li>
        <li><a href="global.html#play">play</a></li>
        <li><a href="global.html#replyRandom">replyRandom</a></li>
        <li><a href="global.html#restart">restart</a></li>
        <li><a href="global.html#resume">resume</a></li>
        <li><a href="global.html#sandwich">sandwich</a></li>
        <li><a href="global.html#save">save</a></li>
        <li><a href="global.html#saveConfig">saveConfig</a></li>
        <li><a href="global.html#saveDatabaseConfig">saveDatabaseConfig</a></li>
        <li><a href="global.html#search">search</a></li>
        <li><a href="global.html#setVolume">setVolume</a></li>
        <li><a href="global.html#skip">skip</a></li>
        <li><a href="global.html#stop">stop</a></li>
        <li><a href="global.html#textChannel">textChannel</a></li>
        <li><a href="global.html#track">track</a></li>
        <li><a href="global.html#voiceConnection">voiceConnection</a></li>
        <li><a href="global.html#volume">volume</a></li>
        <li><a href="global.html#waitForMessage">waitForMessage</a></li>
        <li><a href="global.html#yesNoQuestion">yesNoQuestion</a></li>
    </ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sun Jul 15 2018 14:20:18
    GMT+0200 (GMT+02:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
