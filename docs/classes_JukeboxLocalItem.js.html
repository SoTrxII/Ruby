<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: classes/JukeboxLocalItem.js</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="styles/prettify-tomorrow.css" rel="stylesheet" type="text/css">
    <link href="styles/jsdoc-default.css" rel="stylesheet" type="text/css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: classes/JukeboxLocalItem.js</h1>


    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const JukeboxItem = require('./JukeboxItem');
const {
    readdirSync
} = require('fs');
const {
    readdir
} = require('fs').promises;
const {
    resolve,
    basename,
    extname
} = require('path');
const fuzzySet = require("fuzzyset.js")
const debug = require('debug')('jukeboxLocalItem')

/**
 * @class
 * @extends JukeboxItem
 */
class JukeboxLocalItem extends JukeboxItem {

    constructor(track, voiceConnection, asker) {
        super(track, voiceConnection, asker);
        this.localStorageDir = JukeboxLocalItem._getLocalStoragePath();

        let resolve, reject;
        this.trueTrack = new Promise(function () {
            resolve = arguments[0];
            reject = arguments[1];
        });
        this._getTrueTrackName(resolve, reject);

    }

    async _getTrueTrackName(resolve, reject) {
        const filename = await this._getFileFromAlias(this.track).catch(reject);
        resolve(filename);
    }
    /**
     * @static
     * @private
     * @summary Return where on the disk are the song files
     * @returns {String} Dir path 
     */
    static _getLocalStoragePath() {
        return resolve(__dirname, '../sounds/');
    }

    /**
     * @async
     * @static
     * @override
     * @public
     * @summary Search for item to playback
     * @param {String} query What to search for
     * @param {Discord/VoiceConnection} voiceConnection voicechannel to play into
     * @param {Discord/Member} asker 
     * @param {Integer} [MAX_RESULTS=3]
     * @return {JukeboxItem[]} Found items
     */
    static async search(query, voiceConnection, asker, MAX_RESULTS = 3) {
        /**
         * Use a fuzzy set to match the query 
        * @see{@link https://en.wikipedia.org/wiki/Approximate_string_matching}
        * */
        const songList = fuzzySet(JukeboxLocalItem.getLocalSongList());
        let results = songList.get(query);
        if(!results || !results.length){
            return null;
        }
        if (results.length > MAX_RESULTS){
            results = results.slice(0, MAX_RESULTS);
        }
        return results.map( result => {
            return new JukeboxLocalItem(result[1], voiceConnection, asker);
        })
    }


    /**
     * @static
     * @public
     * @summary Return files aliases list
     * @returns {Object[]} List of aliases
     */
    static getAliases() {
        return {
            'corbeau': [
                'mabite',
                'corbac',
                'vent'
            ],
            'inception': [
                'dooom'
            ],
            'yeah': [

            ]
        }
    }

    /**
     * @static
     * @summary Returns List of local files
     * @returns {String[]} List of file
     */
    static getLocalSongList() {

        const aliases = JukeboxLocalItem.getAliases();

        const files = readdirSync(JukeboxLocalItem._getLocalStoragePath())
        let results = []
        files.map(file => {
            let filename = basename(file, extname(file));
            results.push(filename);
            //Add all aliases as valid property
            if (aliases.hasOwnProperty(filename)) {
                results = results.concat(aliases[filename]);
            }
        })
        return results;
    }

    /**
     * @async
     * @private
     * @summary Take a file alias as parameter and returns the true name of the file with it 's extension.
     * @param {String} alias 
     * @return {String} File true name
     */
    async _getFileFromAlias(alias) {
        const aliases = JukeboxLocalItem.getAliases();

        let filename;
        for (const key of Object.keys(aliases)) {
            const matches = aliases[key].filter((fileAlias) => {
                return fileAlias == alias;
            })
            if (matches.length || key == alias) {
                filename = key
                break;
            }
        }
        // await files;
        //debug(files)
        let files = await readdir(JukeboxLocalItem._getLocalStoragePath())
        const filenameWithExtension = files.filter(file => {
            return filename == basename(file, extname(file));
        })

        debug(filenameWithExtension);

        return filenameWithExtension


    }

    /**
     * @public
     * @summary Play the source
     */
    async play(options) {
        super.play();
        this.trueTrack.then(async () => {
            let tt = await this.trueTrack;
            debug(tt)
            let path = resolve(this.localStorageDir, `./${tt}`);
            debug(path)
            this._dispatcher = this._voiceConnection.playFile(path, options);

            this._dispatcher.on('end', (evt) => {
                /**
                 * Emitted when an item stops playing
                 * @event JukeboxItem#end
                 */
                this.emit('end');
            })
        })

    }

    /**
     * @returns Info about the playback
     */
    async _getInfo() {
        return {
            title: basename(this.track),
            author: 'local',
            image: "https://i.pinimg.com/736x/95/6a/72/956a72e128f787f1c7af24b33b485e81--rwby-rose-rwby-fanart.jpg"
        }
    }

}

module.exports = JukeboxLocalItem;</code></pre>
        </article>
    </section>


</div>

<nav>
    <h2><a href="index.html">Home</a></h2>
    <h3>Modules</h3>
    <ul>
        <li><a href="module-parseTextCommand.html">parseTextCommand</a></li>
    </ul>
    <h3>Classes</h3>
    <ul>
        <li><a href="Jukebox.html">Jukebox</a></li>
        <li><a href="JukeboxFanburstItem.html">JukeboxFanburstItem</a></li>
        <li><a href="JukeboxItem.html">JukeboxItem</a></li>
        <li><a href="JukeboxLocalItem.html">JukeboxLocalItem</a></li>
        <li><a href="JukeboxOpeningmoeItem.html">JukeboxOpeningmoeItem</a></li>
        <li><a href="JukeboxYoutubeItem.html">JukeboxYoutubeItem</a></li>
    </ul>
    <h3>Events</h3>
    <ul>
        <li><a href="Jukebox.html#event:QueueEmpty">QueueEmpty</a></li>
        <li><a href="JukeboxFanburstItem.html#event:end">end</a></li>
        <li><a href="JukeboxItem.html#event:end">end</a></li>
        <li><a href="JukeboxLocalItem.html#event:end">end</a></li>
        <li><a href="JukeboxOpeningmoeItem.html#event:end">end</a></li>
        <li><a href="JukeboxYoutubeItem.html#event:end">end</a></li>
    </ul>
    <h3>Global</h3>
    <ul>
        <li><a href="global.html#_supportedSources">_supportedSources</a></li>
        <li><a href="global.html#addToQueue">addToQueue</a></li>
        <li><a href="global.html#asker">asker</a></li>
        <li><a href="global.html#blindTest">blindTest</a></li>
        <li><a href="global.html#chooseOneItem">chooseOneItem</a></li>
        <li><a href="global.html#displayMessage">displayMessage</a></li>
        <li><a href="global.html#exitHandler">exitHandler</a></li>
        <li><a href="global.html">expiration</a></li>
        <li><a href="global.html#getMember">getMember</a></li>
        <li><a href="global.html#hasBegun">hasBegun</a></li>
        <li><a href="global.html#infos">infos</a></li>
        <li><a href="global.html#isBlindTest">isBlindTest</a></li>
        <li><a href="global.html#isPaused">isPaused</a></li>
        <li><a href="global.html#isPlaying">isPlaying</a></li>
        <li><a href="global.html#list">list</a></li>
        <li><a href="global.html">openingListUpdateDate</a></li>
        <li><a href="global.html#pause">pause</a></li>
        <li><a href="global.html#play">play</a></li>
        <li><a href="global.html#replyRandom">replyRandom</a></li>
        <li><a href="global.html#restart">restart</a></li>
        <li><a href="global.html#resume">resume</a></li>
        <li><a href="global.html#sandwich">sandwich</a></li>
        <li><a href="global.html#save">save</a></li>
        <li><a href="global.html#saveConfig">saveConfig</a></li>
        <li><a href="global.html#saveDatabaseConfig">saveDatabaseConfig</a></li>
        <li><a href="global.html#search">search</a></li>
        <li><a href="global.html#setVolume">setVolume</a></li>
        <li><a href="global.html#skip">skip</a></li>
        <li><a href="global.html#stop">stop</a></li>
        <li><a href="global.html#textChannel">textChannel</a></li>
        <li><a href="global.html#track">track</a></li>
        <li><a href="global.html#voiceConnection">voiceConnection</a></li>
        <li><a href="global.html#volume">volume</a></li>
        <li><a href="global.html#waitForMessage">waitForMessage</a></li>
        <li><a href="global.html#yesNoQuestion">yesNoQuestion</a></li>
    </ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sun Jul 15 2018 14:20:18
    GMT+0200 (GMT+02:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
